<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منصة الأستاذ أحمد شعبان | خبير المواد الفلسفية</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #9d50bb; /* أرجواني فلسفي */
            --secondary: #6e48aa;
            --accent: #ffd700; /* ذهبي للمتميزين */
            --bg: #0f0c29;
            --card-bg: rgba(30, 30, 50, 0.8);
            --text: #ffffff;
            --success: #00c851;
            --danger: #ff4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { 
            background: linear-gradient(to bottom, #24243e, #302b63, #0f0c29); 
            color: var(--text); min-height: 100vh; overflow-x: hidden; 
        }

        header {
            position: fixed; top: 0; width: 100%; background: rgba(15, 12, 41, 0.9);
            padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; z-index: 1000;
            border-bottom: 2px solid var(--primary); backdrop-filter: blur(10px);
        }

        .container { max-width: 1100px; margin: 100px auto 40px; padding: 0 20px; }

        /* البطاقات */
        .glass-card {
            background: var(--card-bg); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
            padding: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        /* مدخلات البيانات */
        input, select { 
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; 
            border: 1px solid var(--primary); background: rgba(255,255,255,0.05); color: #fff;
        }

        /* الأزرار */
        .btn { 
            padding: 12px 25px; border-radius: 10px; border: none; font-weight: bold; 
            cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s;
        }
        .btn-primary { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(157, 80, 187, 0.4); }
        .btn-gold { background: var(--accent); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }

        /* واجهة الاختبار */
        #quiz-container { display: none; }
        .q-text { font-size: 1.5rem; font-weight: 700; margin-bottom: 25px; line-height: 1.6; color: var(--accent); }
        .option-btn {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: #fff; padding: 18px; border-radius: 15px; text-align: right; cursor: pointer; 
            margin-bottom: 12px; font-size: 1.1rem;
        }
        .option-btn.selected { background: var(--primary); border-color: var(--accent); }

        /* تنبيهات مخصصة */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-box { 
            background: #1e1e32; padding: 30px; border-radius: 20px; text-align: center; 
            max-width: 450px; border: 2px solid var(--primary); 
        }

        /* السجل */
        .table-container { overflow-x: auto; margin-top: 20px; border-radius: 15px; }
        table { width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.2); }
        th, td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        th { background: var(--primary); }

        .exam-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.03); padding: 20px; border-radius: 15px; margin-bottom: 15px;
            border-right: 5px solid var(--primary);
        }

        #timer { font-size: 2.5rem; text-align: center; color: var(--danger); font-weight: 900; margin-bottom: 20px; text-shadow: 0 0 10px rgba(255,0,0,0.3); }
    </style>
</head>
<body>

    <header>
        <div style="font-weight: 900; font-size: 1.4rem;"><i class="fas fa-brain"></i> أ. أحمد شعبان</div>
        <div id="user-display" style="font-size: 0.9rem; color: var(--accent);">جاري التحقق...</div>
    </header>

    <div class="container">
        <section id="admin-panel" style="display: none;" class="glass-card animate__animated animate__fadeInDown">
            <h2 style="color: var(--accent);"><i class="fas fa-user-shield"></i> لوحة تحكم الخبير</h2>
            <div style="margin: 20px 0;">
                <input type="text" id="ex-title" placeholder="عنوان المحاضرة أو الاختبار">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="number" id="ex-time" placeholder="وقت الامتحان (دقائق)">
                    <input type="number" id="ex-limit" placeholder="عدد المحاولات">
                </div>
                <div id="questions-builder"></div>
                <button class="btn btn-outline" onclick="addQuestionRaw()" style="width: 100%; margin-top: 10px;">+ أضف سؤال جديد</button>
                <button class="btn btn-primary" onclick="publishExam()" style="width: 100%; margin-top: 15px; justify-content: center;">نشر الاختبار للطلاب</button>
            </div>
        </section>

        <section id="student-view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3><i class="fas fa-scroll"></i> اختبارات الفلسفة والمنطق</h3>
                <button id="admin-btn" class="btn btn-gold" style="display: none;" onclick="document.getElementById('admin-panel').style.display='block'">لوحة المستر</button>
            </div>
            <div id="exams-list"></div>
        </section>

        <section id="quiz-container" class="glass-card animate__animated animate__zoomIn">
            <div id="timer">00:00</div>
            <p class="q-text" id="q-text-display"></p>
            <div id="options-display"></div>
            <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                <button class="btn btn-outline" onclick="changeQ(-1)">السابق</button>
                <span id="progress">1 / 10</span>
                <button class="btn btn-primary" id="next-btn" onclick="changeQ(1)">التالي</button>
                <button class="btn btn-gold" id="final-submit" style="display: none;" onclick="openConfirm()">تسليم الإجابات</button>
            </div>
        </section>

        <section id="results-section" style="display: none;" class="glass-card animate__animated animate__fadeInUp" style="margin-top: 30px;">
            <h3><i class="fas fa-chart-line"></i> سجل أداء الطلاب</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>الطالب</th>
                            <th>الاختبار</th>
                            <th>الدرجة</th>
                            <th>صح/خطأ</th>
                        </tr>
                    </thead>
                    <tbody id="results-table"></tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-box">
            <i class="fas fa-question-circle" style="font-size: 3rem; color: var(--accent);"></i>
            <h3 style="margin: 15px 0;">هل تأكدت من جميع إجاباتك؟</h3>
            <p>لا يمكن التعديل بعد التأكيد الفلسفي النهائي.</p>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                <button class="btn btn-primary" onclick="processFinish()">نعم، سلم الآن</button>
                <button class="btn btn-outline" onclick="document.getElementById('confirm-modal').style.display='none'">مراجعة</button>
            </div>
        </div>
    </div>

    <div id="result-modal" class="modal">
        <div class="modal-box" style="max-height: 80vh; overflow-y: auto;">
            <h2 style="color: var(--accent);">انتهى الاختبار</h2>
            <div id="final-stats" style="font-size: 1.5rem; margin: 20px 0;"></div>
            <div id="analysis-box" style="text-align: right; margin-bottom: 20px;"></div>
            <button class="btn btn-primary" onclick="location.reload()">العودة للرئيسية</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script>
        // --- إعدادات المستر أحمد شعبان ---
        const firebaseConfig = {
            apiKey: "AIzaSyCcFRLMsewcgYXYgVvdkyQHf-imoJHHzng",
            authDomain: "mrhamdy-1c406.firebaseapp.com",
            databaseURL: "https://mrhamdy-1c406-default-rtdb.firebaseio.com",
            projectId: "mrhamdy-1c406",
            storageBucket: "mrhamdy-1c406.firebasestorage.app",
            messagingSenderId: "806268398144",
            appId: "1:806268398144:web:e7c9b87205cbb6fb2b4da5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const phone = localStorage.getItem('userLoggedIn');
        let myData = null;
        let exam = null;
        let answers = [];
        let cur = 0;
        let timer;

        // التحقق من الدخول
        if(!phone) { window.location.href = "index.html"; }
        else {
            db.ref('students/'+phone).on('value', s => {
                myData = s.val();
                if(!myData) return;
                document.getElementById('user-display').innerText = "مرحباً بك: " + myData.name;
                
                // تحديد صلاحيات المستر (ضع رقم موبايلك هنا)
                if(phone === "01287110940" || myData.role === "admin") {
                    document.getElementById('admin-btn').style.display = 'block';
                    document.getElementById('results-section').style.display = 'block';
                    loadAllResults();
                }
                loadExams();
            });
        }

        // بناء الأسئلة (أدمن)
        let qIdx = 0;
        function addQuestionRaw() {
            qIdx++;
            const div = document.createElement('div');
            div.className = 'glass-card';
            div.style.marginTop = '10px';
            div.innerHTML = `
                <b>سؤال ${qIdx}</b>
                <input type="text" class="qt" placeholder="نص السؤال الفلسفي">
                <input type="text" class="o1" placeholder="خيار 1">
                <input type="text" class="o2" placeholder="خيار 2">
                <input type="text" class="o3" placeholder="خيار 3">
                <input type="text" class="o4" placeholder="خيار 4">
                <input type="text" class="qc" placeholder="الإجابة الصحيحة نصاً" style="border-color:var(--success)">
            `;
            document.getElementById('questions-builder').appendChild(div);
        }

        function publishExam() {
            const qs = [];
            document.querySelectorAll('#questions-builder div').forEach(d => {
                qs.push({
                    text: d.querySelector('.qt').value,
                    options: [d.querySelector('.o1').value, d.querySelector('.o2').value, d.querySelector('.o3').value, d.querySelector('.o4').value],
                    correct: d.querySelector('.qc').value
                });
            });
            db.ref('exams').push({
                title: document.getElementById('ex-title').value,
                time: document.getElementById('ex-time').value,
                limit: document.getElementById('ex-limit').value,
                questions: qs
            }).then(() => location.reload());
        }

        // تحميل الامتحانات للطلاب
        function loadExams() {
            db.ref('exams').on('value', s => {
                const list = document.getElementById('exams-list');
                list.innerHTML = '';
                s.forEach(child => {
                    const ex = child.val();
                    const tried = (myData.attempts && myData.attempts[child.key]) || 0;
                    list.innerHTML += `
                        <div class="exam-item">
                            <div>
                                <h4>${ex.title}</h4>
                                <small>${ex.time} دقيقة | محاولاتك: ${tried}/${ex.limit}</small>
                            </div>
                            <button class="btn btn-primary" onclick="startQuiz('${child.key}')" ${tried >= ex.limit ? 'disabled' : ''}>ابدأ التفكير</button>
                        </div>
                    `;
                });
            });
        }

        function startQuiz(id) {
            db.ref('exams/'+id).once('value', s => {
                exam = s.val();
                exam.id = id;
                answers = new Array(exam.questions.length).fill(null);
                document.getElementById('student-view').style.display = 'none';
                document.getElementById('quiz-container').style.display = 'block';
                renderQ();
                startClock(exam.time * 60);
            });
        }

        function renderQ() {
            const q = exam.questions[cur];
            document.getElementById('q-text-display').innerText = q.text;
            document.getElementById('progress').innerText = `${cur + 1} / ${exam.questions.length}`;
            
            const optDiv = document.getElementById('options-display');
            optDiv.innerHTML = '';
            q.options.forEach(o => {
                const b = document.createElement('button');
                b.className = `option-btn ${answers[cur] === o ? 'selected' : ''}`;
                b.innerText = o;
                b.onclick = () => { answers[cur] = o; renderQ(); };
                optDiv.appendChild(b);
            });

            document.getElementById('next-btn').style.display = cur === exam.questions.length - 1 ? 'none' : 'block';
            document.getElementById('final-submit').style.display = cur === exam.questions.length - 1 ? 'block' : 'none';
        }

        function changeQ(dir) {
            if(cur + dir >= 0 && cur + dir < exam.questions.length) {
                cur += dir;
                renderQ();
            }
        }

        function startClock(sec) {
            timer = setInterval(() => {
                let m = Math.floor(sec / 60);
                let s = sec % 60;
                document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                if(sec <= 0) processFinish();
                sec--;
            }, 1000);
        }

        function openConfirm() { document.getElementById('confirm-modal').style.display = 'flex'; }

        function processFinish() {
            clearInterval(timer);
            let score = 0;
            let review = "";
            exam.questions.forEach((q, i) => {
                const isRight = answers[i] === q.correct;
                if(isRight) score++;
                review += `
                    <div style="padding:10px; border-bottom:1px solid #444; color:${isRight ? 'var(--success)' : 'var(--danger)'}">
                        <b>س${i+1}:</b> ${isRight ? 'إجابة صحيحة ✓' : 'إجابة خاطئة ✗'} <br>
                        <small style="color:#aaa">الصحيح: ${q.correct}</small>
                    </div>`;
            });

            const percent = ((score / exam.questions.length) * 100).toFixed(1);
            
            // رفع النتيجة
            db.ref('students/'+phone+'/attempts/'+exam.id).transaction(c => (c || 0) + 1);
            db.ref('results').push({
                name: myData.name,
                exam: exam.title,
                score: percent + "%",
                details: `${score} صح من ${exam.questions.length}`
            });

            document.getElementById('confirm-modal').style.display = 'none';
            document.getElementById('result-modal').style.display = 'flex';
            document.getElementById('final-stats').innerHTML = `درجتك: ${percent}% <br> <small>(${score} إجابة صحيحة)</small>`;
            document.getElementById('analysis-box').innerHTML = review;
        }

        function loadAllResults() {
            db.ref('results').on('value', s => {
                const body = document.getElementById('results-table');
                body.innerHTML = '';
                s.forEach(child => {
                    const r = child.val();
                    body.innerHTML = `<tr><td>${r.name}</td><td>${r.exam}</td><td style="color:var(--accent)">${r.score}</td><td>${r.details}</td></tr>` + body.innerHTML;
                });
            });
        }
    </script>
</body>
</html>
