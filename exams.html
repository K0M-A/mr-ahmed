<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منصة الأستاذ أحمد شعبان | خبير المواد الفلسفية</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #8e24aa; /* أرجواني ملكي */
            --secondary: #5e35b1;
            --accent: #ffb300; /* ذهبي */
            --bg: #0a0a1a;
            --card-bg: rgba(25, 25, 45, 0.9);
            --text: #ffffff;
            --success: #00e676;
            --danger: #ff1744;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body { background: radial-gradient(circle at center, #1a1a2e 0%, #0a0a1a 100%); color: var(--text); min-height: 100vh; overflow-x: hidden; }

        header {
            position: fixed; top: 0; width: 100%; background: rgba(10, 10, 26, 0.95);
            padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; z-index: 1000;
            border-bottom: 2px solid var(--primary); backdrop-filter: blur(10px);
        }

        .container { max-width: 1000px; margin: 100px auto 40px; padding: 0 20px; }

        /* البطاقات */
        .glass-card { background: var(--card-bg); border-radius: 20px; border: 1px solid rgba(142, 36, 170, 0.3); padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); margin-bottom: 20px; }

        /* مدخلات */
        input, select { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #333; background: #121225; color: #fff; outline: none; }
        input:focus { border-color: var(--primary); }

        /* أزرار */
        .btn { padding: 12px 25px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 1rem; }
        .btn-primary { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; }
        .btn-gold { background: var(--accent); color: #000; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; }

        /* واجهة الاختبار */
        #quiz-container { display: none; }
        #timer { font-size: 2.5rem; text-align: center; color: var(--danger); font-weight: 900; margin-bottom: 20px; text-shadow: 0 0 10px rgba(255, 23, 68, 0.2); }
        .q-text { font-size: 1.4rem; font-weight: 700; margin-bottom: 30px; line-height: 1.7; color: var(--accent); border-right: 4px solid var(--primary); padding-right: 15px; }
        .option-btn { width: 100%; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 20px; border-radius: 15px; text-align: right; cursor: pointer; margin-bottom: 12px; font-size: 1.1rem; }
        .option-btn:hover { background: rgba(142, 36, 170, 0.15); border-color: var(--primary); }
        .option-btn.selected { background: var(--primary); border-color: var(--accent); box-shadow: 0 0 20px rgba(142, 36, 170, 0.4); }

        .quiz-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }

        /* مودال التنبيهات */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: #1a1a2e; padding: 35px; border-radius: 25px; border: 2px solid var(--primary); text-align: center; max-width: 500px; width: 100%; box-shadow: 0 0 50px rgba(142, 36, 170, 0.3); }

        /* النتائج */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .stat-card { padding: 20px; border-radius: 15px; text-align: center; font-weight: 900; font-size: 1.2rem; }
        .correct-bg { background: rgba(0, 230, 118, 0.1); color: var(--success); border: 1px solid var(--success); }
        .wrong-bg { background: rgba(255, 23, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }

        /* الجدول للمستر */
        .table-container { overflow-x: auto; background: rgba(0,0,0,0.3); border-radius: 15px; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 18px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        th { background: var(--primary); color: white; }

        .exam-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); padding: 20px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid var(--accent); }
    </style>
</head>
<body>

    <header>
        <div style="font-weight: 900; font-size: 1.4rem; color: var(--accent);"><i class="fas fa-landmark"></i> منصة أ. أحمد شعبان</div>
        <div id="user-info" style="font-weight: bold; background: rgba(142, 36, 170, 0.2); padding: 8px 18px; border-radius: 12px; border: 1px solid var(--primary);">جاري التحميل...</div>
    </header>

    <div class="container">
        <section id="admin-area" style="display: none;" class="glass-card animate__animated animate__fadeInDown">
            <h2 style="color: var(--accent); margin-bottom: 20px;"><i class="fas fa-tools"></i> غرفة إعداد الاختبارات</h2>
            <input type="text" id="ex-title" placeholder="عنوان الاختبار (مثلاً: الفلسفة المعاصرة)">
            <div style="display: flex; gap: 15px;">
                <input type="number" id="ex-time" placeholder="وقت الامتحان (بالدقائق)">
                <input type="number" id="ex-limit" placeholder="عدد المحاولات المسموحة">
            </div>
            <div id="builder-container"></div>
            <button class="btn btn-outline" onclick="addNewQuestion()" style="width: 100%; margin-top: 15px;">+ إضافة سؤال جديد</button>
            <button class="btn btn-primary" onclick="saveToFirebase()" style="width: 100%; margin-top: 20px; justify-content: center;">نشر الاختبار للطلاب</button>
        </section>

        <section id="exams-view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="font-weight: 900;">⚡ الاختبارات النشطة</h2>
                <button id="admin-toggle" class="btn btn-gold" style="display: none;" onclick="toggleAdmin()">لوحة المستر</button>
            </div>
            <div id="exams-list-container"></div>
        </section>

        <section id="quiz-container" class="glass-card animate__animated animate__fadeIn">
            <div id="timer">00:00</div>
            <div id="q-area">
                <p class="q-text" id="display-q-text"></p>
                <div id="display-options"></div>
            </div>
            <div class="quiz-footer">
                <button class="btn btn-outline" id="prev-btn" onclick="moveQ(-1)"><i class="fas fa-arrow-right"></i> السابق</button>
                <div style="font-weight: bold; color: var(--accent);">سؤال <span id="q-curr">1</span> من <span id="q-total">0</span></div>
                <button class="btn btn-primary" id="next-btn" onclick="moveQ(1)">التالي <i class="fas fa-arrow-left"></i></button>
                <button class="btn btn-gold" id="submit-trigger" style="display: none;" onclick="showConfirmModal()">تسليم الاختبار</button>
            </div>
        </section>

        <section id="admin-results" style="display: none;" class="glass-card animate__animated animate__fadeInUp">
            <h3 style="color: var(--accent);"><i class="fas fa-poll"></i> سجل أداء الطلاب</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>الطالب</th>
                            <th>الاختبار</th>
                            <th>النتيجة</th>
                            <th>صح / خطأ</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body"></tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content animate__animated animate__zoomIn">
            <i class="fas fa-question-circle" style="font-size: 4rem; color: var(--accent); margin-bottom: 20px;"></i>
            <h2>تأكيد تسليم الاختبار؟</h2>
            <p style="margin: 15px 0; opacity: 0.8;">راجع إجاباتك الفلسفية بعناية قبل الإرسال.</p>
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
                <button class="btn btn-primary" onclick="finalSubmit()">نعم، سلم الآن</button>
                <button class="btn btn-danger" onclick="closeConfirmModal()">مراجعة الإجابات</button>
            </div>
        </div>
    </div>

    <div id="resultModal" class="modal">
        <div class="modal-content animate__animated animate__bounceIn" style="max-height: 85vh; overflow-y: auto;">
            <h1 id="res-grade" style="color: var(--accent); font-size: 3rem;">0%</h1>
            <div class="stat-grid">
                <div class="stat-card correct-bg"><i class="fas fa-check-circle"></i> صحيح: <span id="res-correct">0</span></div>
                <div class="stat-card wrong-bg"><i class="fas fa-times-circle"></i> خطأ: <span id="res-wrong">0</span></div>
            </div>
            <div id="analysis-box" style="text-align: right; margin-top: 20px; border-top: 1px solid #333; padding-top: 20px;"></div>
            <button class="btn btn-primary" onclick="location.reload()" style="width: 100%; margin-top: 20px; justify-content: center;">العودة للرئيسية</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script>
        // --- تهيئة فايرباز أ. أحمد شعبان الفعلي ---
        const firebaseConfig = {
            apiKey: "AIzaSyBfkxj5I7UOEETOf9GRqGgqEaEoqPtPMek",
            authDomain: "mrahmed-925d8.firebaseapp.com",
            databaseURL: "https://mrahmed-925d8-default-rtdb.firebaseio.com",
            projectId: "mrahmed-925d8",
            storageBucket: "mrahmed-925d8.firebasestorage.app",
            messagingSenderId: "83939909031",
            appId: "1:83939909031:web:adb0b10d41b9df6c602a82"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const userPhone = localStorage.getItem('userLoggedIn');
        let userData = null, activeExam = null, userAnswers = [], qIndex = 0, timerInterval;

        // --- الأمان والتحقق ---
        if (!userPhone) {
            window.location.href = "index.html";
        } else {
            db.ref('students/' + userPhone).on('value', snap => {
                userData = snap.val();
                if (!userData) return;
                document.getElementById('user-info').innerText = "أهلاً: " + userData.name.split(' ')[0];
                
                // صلاحيات المستر أحمد (تفتح بالرقم الخاص به أو دور admin)
                if (userPhone === "01287110940" || userData.role === "admin") {
                    document.getElementById('admin-toggle').style.display = 'block';
                    document.getElementById('admin-results').style.display = 'block';
                    loadAdminResults();
                }
                loadExams();
            });
        }

        // --- وظائف الأدمن ---
        function toggleAdmin() {
            const area = document.getElementById('admin-area');
            area.style.display = area.style.display === 'block' ? 'none' : 'block';
        }

        let qCount = 0;
        function addNewQuestion() {
            qCount++;
            const html = `
                <div class="glass-card animate__animated animate__fadeInLeft" style="margin-top:15px; border-right: 4px solid var(--accent);">
                    <b>السؤال رقم ${qCount}</b>
                    <input type="text" class="q-input-text" placeholder="اكتب نص السؤال هنا...">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <input type="text" class="opt-1" placeholder="خيار 1">
                        <input type="text" class="opt-2" placeholder="خيار 2">
                        <input type="text" class="opt-3" placeholder="خيار 3">
                        <input type="text" class="opt-4" placeholder="خيار 4">
                    </div>
                    <input type="text" class="q-input-correct" placeholder="الإجابة الصحيحة (يجب أن تطابق أحد الخيارات)" style="border-color:var(--success)">
                </div>`;
            document.getElementById('builder-container').insertAdjacentHTML('beforeend', html);
        }

        function saveToFirebase() {
            const title = document.getElementById('ex-title').value;
            const time = document.getElementById('ex-time').value;
            const limit = document.getElementById('ex-limit').value;
            const cards = document.querySelectorAll('#builder-container .glass-card');
            
            let questions = [];
            cards.forEach(c => {
                questions.push({
                    text: c.querySelector('.q-input-text').value,
                    options: [c.querySelector('.opt-1').value, c.querySelector('.opt-2').value, c.querySelector('.opt-3').value, c.querySelector('.opt-4').value],
                    correct: c.querySelector('.q-input-correct').value
                });
            });

            if (!title || questions.length === 0) return alert("أكمل بيانات الاختبار يا مستر أحمد.");

            db.ref('exams').push({ title, time, limit, questions }).then(() => location.reload());
        }

        // --- وظائف الطالب ---
        function loadExams() {
            db.ref('exams').on('value', snap => {
                const container = document.getElementById('exams-list-container');
                container.innerHTML = '';
                snap.forEach(child => {
                    const ex = child.val();
                    const tried = (userData.examAttempts && userData.examAttempts[child.key]) || 0;
                    container.innerHTML += `
                        <div class="exam-item animate__animated animate__fadeInUp">
                            <div>
                                <h3 style="color:var(--accent);">${ex.title}</h3>
                                <p style="font-size:0.9rem; opacity:0.7;">${ex.time} دقيقة | محاولاتك: ${tried} من ${ex.limit}</p>
                            </div>
                            <button class="btn btn-primary" onclick="startExam('${child.key}')" ${tried >= ex.limit ? 'disabled style="opacity:0.5;"' : ''}>
                                ${tried >= ex.limit ? 'انتهت المحاولات' : 'بدء الاختبار'}
                            </button>
                        </div>`;
                });
            });
        }

        function startExam(id) {
            db.ref('exams/' + id).once('value', snap => {
                activeExam = snap.val();
                activeExam.id = id;
                userAnswers = new Array(activeExam.questions.length).fill(null);
                
                document.getElementById('exams-view').style.display = 'none';
                document.getElementById('admin-area').style.display = 'none';
                document.getElementById('quiz-container').style.display = 'block';
                
                renderQuestion();
                startTimer(activeExam.time * 60);
            });
        }

        function renderQuestion() {
            const q = activeExam.questions[qIndex];
            document.getElementById('display-q-text').innerText = q.text;
            document.getElementById('q-curr').innerText = qIndex + 1;
            document.getElementById('q-total').innerText = activeExam.questions.length;

            const optContainer = document.getElementById('display-options');
            optContainer.innerHTML = '';
            
            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn ' + (userAnswers[qIndex] === opt ? 'selected' : '');
                btn.innerText = opt;
                btn.onclick = () => {
                    userAnswers[qIndex] = opt;
                    renderQuestion();
                };
                optContainer.appendChild(btn);
            });

            // التحكم بالأزرار
            document.getElementById('prev-btn').style.visibility = qIndex === 0 ? 'hidden' : 'visible';
            if (qIndex === activeExam.questions.length - 1) {
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('submit-trigger').style.display = 'inline-flex';
            } else {
                document.getElementById('next-btn').style.display = 'inline-flex';
                document.getElementById('submit-trigger').style.display = 'none';
            }
        }

        function moveQ(step) {
            qIndex += step;
            renderQuestion();
        }

        function startTimer(sec) {
            timerInterval = setInterval(() => {
                let m = Math.floor(sec / 60);
                let s = sec % 60;
                document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                if (sec <= 0) finalSubmit();
                sec--;
            }, 1000);
        }

        function showConfirmModal() { document.getElementById('confirmModal').style.display = 'flex'; }
        function closeConfirmModal() { document.getElementById('confirmModal').style.display = 'none'; }

        function finalSubmit() {
            clearInterval(timerInterval);
            closeConfirmModal();
            
            let correctCount = 0;
            let analysisHtml = '<h4>مراجعة الإجابات:</h4>';

            activeExam.questions.forEach((q, i) => {
                const isCorrect = userAnswers[i] === q.correct;
                if (isCorrect) correctCount++;
                analysisHtml += `
                    <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:10px; margin-top:10px; border-right:4px solid ${isCorrect ? 'var(--success)' : 'var(--danger)'}">
                        <p>س${i+1}: ${q.text}</p>
                        <p style="font-size:0.9rem;">إجابتك: ${userAnswers[i] || 'لم تجب'}</p>
                        ${!isCorrect ? `<p style="font-size:0.9rem; color:var(--success)">الصحيح: ${q.correct}</p>` : ''}
                    </div>`;
            });

            const grade = ((correctCount / activeExam.questions.length) * 100).toFixed(1);
            
            // تسجيل في قاعدة البيانات
            db.ref('students/' + userPhone + '/examAttempts/' + activeExam.id).transaction(c => (c || 0) + 1);
            db.ref('examResults').push({
                studentName: userData.name,
                examTitle: activeExam.title,
                score: grade + "%",
                correct: correctCount,
                wrong: activeExam.questions.length - correctCount,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // عرض النتائج
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('resultModal').style.display = 'flex';
            document.getElementById('res-grade').innerText = grade + "%";
            document.getElementById('res-correct').innerText = correctCount;
            document.getElementById('res-wrong').innerText = activeExam.questions.length - correctCount;
            document.getElementById('analysis-box').innerHTML = analysisHtml;
        }

        function loadAdminResults() {
            db.ref('examResults').on('value', snap => {
                const body = document.getElementById('results-table-body');
                body.innerHTML = '';
                snap.forEach(child => {
                    const r = child.val();
                    body.innerHTML = `<tr>
                        <td>${r.studentName}</td>
                        <td>${r.examTitle}</td>
                        <td style="color:var(--accent); font-weight:bold;">${r.score}</td>
                        <td><span style="color:var(--success)">${r.correct}</span> / <span style="color:var(--danger)">${r.wrong}</span></td>
                    </tr>` + body.innerHTML;
                });
            });
        }
    </script>
</body>
</html>
