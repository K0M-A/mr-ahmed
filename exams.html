<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة الأستاذ أحمد شعبان | نظام الاختبارات المتكامل</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #d4af37;
            --bg: #050505;
            --card-bg: rgba(255, 255, 255, 0.05);
            --text: #e2e8f0;
            --gold: #d4af37;
            --danger: #ff1744;
            --success: #28a745;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.3s; }
        body { background-color: var(--bg); color: var(--text); padding-bottom: 50px; min-height: 100vh; overflow-x: hidden; }

        header {
            position: fixed; top: 0; left: 0; width: 100%; background: rgba(10,10,10,0.95);
            padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; z-index: 1000;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2); backdrop-filter: blur(10px);
        }

        .container { max-width: 900px; margin: 100px auto 20px; padding: 0 20px; }

        /* لوحة التحكم للأدمن فقط */
        #admin-editor { display: none; background: #111; padding: 25px; border-radius: 20px; border: 1px solid var(--primary); margin-bottom: 40px; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #333; background: #1a1a1a; color: #fff; }
        .q-card { background: #1a1a1a; padding: 20px; border-radius: 15px; margin-top: 15px; border-right: 4px solid var(--primary); }
        
        /* أزرار */
        .btn { padding: 12px 25px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-success { background: var(--success); color: #fff; width: 100%; justify-content: center; margin-top: 20px; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-danger { background: var(--danger); color: #fff; padding: 5px 15px; font-size: 0.8rem; }

        /* عرض الامتحانات */
        .exam-card {
            background: var(--card-bg); border: 1px solid rgba(212, 175, 55, 0.1);
            padding: 20px; border-radius: 20px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .exam-card:hover { border-color: var(--primary); transform: scale(1.02); }

        /* واجهة الاختبار */
        #quiz-container { display: none; background: #0c0c0c; padding: 30px; border-radius: 25px; border: 2px solid var(--primary); box-shadow: 0 0 40px rgba(212,175,55,0.1); }
        #timer { font-size: 2rem; color: var(--danger); font-weight: 900; text-align: center; margin-bottom: 20px; font-family: monospace; }
        .question-text { font-size: 1.3rem; margin-bottom: 25px; line-height: 1.6; }
        .options-grid { display: grid; gap: 12px; }
        .option-btn {
            background: rgba(255,255,255,0.03); border: 1px solid #333; color: #fff;
            padding: 18px; border-radius: 15px; text-align: right; cursor: pointer;
        }
        .option-btn:hover { border-color: var(--primary); background: rgba(212,175,55,0.1); }

        /* جدول النتائج */
        #admin-results { display: none; margin-top: 50px; }
        table { width: 100%; border-collapse: collapse; background: #111; border-radius: 15px; overflow: hidden; }
        th, td { padding: 15px; text-align: center; border-bottom: 1px solid #222; }
        th { background: var(--primary); color: #000; }

        @media (max-width: 600px) {
            .exam-card { flex-direction: column; text-align: center; gap: 15px; }
        }
    </style>
</head>
<body>

    <header>
        <div style="font-weight: 900; color: var(--primary); font-size: 1.2rem;">⚜️ نظام الاختبارات</div>
        <div id="user-info" style="font-weight: bold;">جاري التحقق...</div>
    </header>

    <div class="container">
        
        <section id="admin-editor" class="animate__animated animate__fadeInDown">
            <h2 style="color: var(--primary); margin-bottom: 20px;"><i class="fas fa-plus-circle"></i> إنشاء امتحان جديد</h2>
            <input type="text" id="ex-title" placeholder="اسم الامتحان (مثلاً: الباب الأول)">
            <div style="display: flex; gap: 10px;">
                <input type="number" id="ex-duration" placeholder="المدة بالدقائق">
                <input type="number" id="ex-attempts" placeholder="عدد المحاولات المتاحة">
            </div>
            
            <div id="questions-list"></div>
            
            <button class="btn btn-outline" onclick="addNewQuestionField()" style="margin-top: 15px;">
                <i class="fas fa-plus"></i> إضافة سؤال
            </button>
            <button class="btn btn-success" onclick="saveExamToDB()">
                <i class="fas fa-save"></i> حفظ ونشر الامتحان للطلاب
            </button>
        </section>

        <section id="exams-view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="color: var(--gold);">الامتحانات المتاحة</h2>
                <button id="admin-toggle-btn" class="btn btn-outline" style="display: none;" onclick="toggleEditor()">
                    <i class="fas fa-tools"></i> لوحة الإضافة
                </button>
            </div>
            <div id="exams-list-container"></div>
        </section>

        <section id="quiz-container" class="animate__animated animate__zoomIn">
            <div id="timer">00:00</div>
            <div id="q-box">
                <p class="question-text" id="display-q-text"></p>
                <div class="options-grid" id="display-options"></div>
            </div>
            <p style="text-align: center; margin-top: 25px; opacity: 0.5; font-size: 0.8rem;">
                سؤال <span id="q-curr">1</span> من <span id="q-total">0</span>
            </p>
        </section>

        <section id="admin-results" class="animate__animated animate__fadeInUp">
            <h3 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-poll"></i> سجل نتائج الطلاب</h3>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>الطالب</th>
                            <th>الرقم</th>
                            <th>الامتحان</th>
                            <th>الدرجة</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body"></tbody>
                </table>
            </div>
        </section>

    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script>
        // --- تهيئة Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyBfkxj5I7UOEETOf9GRqGgqEaEoqPtPMek",
            authDomain: "mrahmed-925d8.firebaseapp.com",
            databaseURL: "https://mrahmed-925d8-default-rtdb.firebaseio.com",
            projectId: "mrahmed-925d8",
            storageBucket: "mrahmed-925d8.firebasestorage.app",
            messagingSenderId: "83939909031",
            appId: "1:83939909031:web:adb0b10d41b9df6c602a82"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- متغيرات الجلسة ---
        const userPhone = localStorage.getItem('userLoggedIn');
        const sessionID = Math.random().toString(36).substring(7);
        let userData = null;
        let activeExam = null;
        let timerInterval;
        let qIndex = 0;
        let score = 0;

        // --- التحقق من الهوية والأمان ---
        if (!userPhone) {
            window.location.href = "go.html";
        } else {
            db.ref('students/' + userPhone).on('value', (snap) => {
                userData = snap.val();
                if (!userData) { logout(); return; }
                if (userData.status === "blocked") { window.location.href = "contact.html"; return; }
                
                // منع الدخول المزدوج
                if (userData.currentSession && userData.currentSession !== sessionID) {
                    alert("عذراً، هذا الحساب مفتوح من جهاز آخر حالياً.");
                    logout();
                }

                document.getElementById('user-info').innerText = "أهلاً، " + userData.name.split(' ')[0];

                // كشف الرول (أدمن أم طالب)
                if (userData.role === "admin" || userPhone === "01025768529") {
                    document.getElementById('admin-toggle-btn').style.display = 'flex';
                    document.getElementById('admin-results').style.display = 'block';
                    loadResultsForAdmin();
                }
                loadExamsList();
            });
            db.ref('students/' + userPhone + '/currentSession').set(sessionID);
        }

        // --- وظائف الأدمن ---
        function toggleEditor() {
            const editor = document.getElementById('admin-editor');
            editor.style.display = (editor.style.display === 'block') ? 'none' : 'block';
        }

        let qCounter = 0;
        function addNewQuestionField() {
            qCounter++;
            const html = `
                <div class="q-card" id="q-field-${qCounter}">
                    <div style="display:flex; justify-content:space-between;">
                        <b>سؤال ${qCounter}</b>
                        <button class="btn btn-danger" onclick="document.getElementById('q-field-${qCounter}').remove()">حذف</button>
                    </div>
                    <input type="text" class="q-text" placeholder="نص السؤال">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                        <input type="text" class="opt-1" placeholder="إجابة 1">
                        <input type="text" class="opt-2" placeholder="إجابة 2">
                        <input type="text" class="opt-3" placeholder="إجابة 3">
                        <input type="text" class="opt-4" placeholder="إجابة 4">
                    </div>
                    <input type="text" class="q-correct" placeholder="اكتب الإجابة الصحيحة بالضبط">
                </div>
            `;
            document.getElementById('questions-list').insertAdjacentHTML('beforeend', html);
        }

        function saveExamToDB() {
            const title = document.getElementById('ex-title').value;
            const duration = document.getElementById('ex-duration').value;
            const attempts = document.getElementById('ex-attempts').value;
            const cards = document.querySelectorAll('.q-card');
            
            let questions = [];
            cards.forEach(c => {
                questions.push({
                    text: c.querySelector('.q-text').value,
                    options: [
                        c.querySelector('.opt-1').value,
                        c.querySelector('.opt-2').value,
                        c.querySelector('.opt-3').value,
                        c.querySelector('.opt-4').value
                    ],
                    correctAnswer: c.querySelector('.q-correct').value
                });
            });

            if (!title || questions.length === 0) return alert("اكمل بيانات الامتحان أولاً");

            db.ref('exams').push({
                title, duration: parseInt(duration), maxAttempts: parseInt(attempts), questions
            }).then(() => {
                alert("تم نشر الامتحان بنجاح");
                location.reload();
            });
        }

        function loadResultsForAdmin() {
            db.ref('examResults').limitToLast(50).on('value', (snap) => {
                const tbody = document.getElementById('results-table-body');
                tbody.innerHTML = '';
                snap.forEach(child => {
                    const r = child.val();
                    tbody.innerHTML = `<tr>
                        <td>${r.studentName}</td>
                        <td>${r.studentPhone}</td>
                        <td>${r.examTitle}</td>
                        <td style="color:var(--gold); font-weight:bold;">${r.score}</td>
                    </tr>` + tbody.innerHTML;
                });
            });
        }

        // --- وظائف الطالب ---
        function loadExamsList() {
            db.ref('exams').on('value', (snap) => {
                const list = document.getElementById('exams-list-container');
                list.innerHTML = '';
                const hasCourse = userData.courses && Object.keys(userData.courses).length > 0;

                snap.forEach(child => {
                    const ex = child.val();
                    const key = child.key;
                    const done = (userData.examAttempts && userData.examAttempts[key]) || 0;
                    
                    const card = document.createElement('div');
                    card.className = 'exam-card';
                    card.innerHTML = `
                        <div>
                            <h3 style="color:var(--gold)">${ex.title}</h3>
                            <p style="font-size:0.8rem; opacity:0.7">المدة: ${ex.duration} د | المحاولات المستخدمة: ${done} من ${ex.maxAttempts}</p>
                        </div>
                        <button class="btn btn-primary" onclick="startExam('${key}')" 
                            ${(!hasCourse || done >= ex.maxAttempts) ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}>
                            ${hasCourse ? (done >= ex.maxAttempts ? 'انتهت المحاولات' : 'ابدأ الآن') : 'اشترك أولاً'}
                        </button>
                    `;
                    list.appendChild(card);
                });
            });
        }

        function startExam(id) {
            db.ref('exams/' + id).once('value', (snap) => {
                activeExam = snap.val();
                activeExam.id = id;
                activeExam.questions = shuffle(activeExam.questions); // لخبطة الأسئلة
                
                document.getElementById('exams-view').style.display = 'none';
                document.getElementById('admin-editor').style.display = 'none';
                document.getElementById('quiz-container').style.display = 'block';
                
                qIndex = 0; score = 0;
                renderQuestion();
                startTimer(activeExam.duration * 60);
            });
        }

        function renderQuestion() {
            if (qIndex >= activeExam.questions.length) return finishQuiz();

            const q = activeExam.questions[qIndex];
            document.getElementById('display-q-text').innerText = q.text;
            document.getElementById('q-curr').innerText = qIndex + 1;
            document.getElementById('q-total').innerText = activeExam.questions.length;

            const optsDiv = document.getElementById('display-options');
            optsDiv.innerHTML = '';
            
            const shuffledOpts = shuffle([...q.options]); // لخبطة الإجابات
            shuffledOpts.forEach(o => {
                const b = document.createElement('button');
                b.className = 'option-btn';
                b.innerText = o;
                b.onclick = () => {
                    if (o === q.correctAnswer) score++;
                    qIndex++;
                    renderQuestion();
                };
                optsDiv.appendChild(b);
            });
        }

        function startTimer(sec) {
            timerInterval = setInterval(() => {
                let m = Math.floor(sec / 60);
                let s = sec % 60;
                document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                if (sec <= 0) finishQuiz();
                sec--;
            }, 1000);
        }

        function finishQuiz() {
            clearInterval(timerInterval);
            const grade = ((score / activeExam.questions.length) * 100).toFixed(1);
            
            // تسجيل المحاولة والنتيجة
            db.ref('students/' + userPhone + '/examAttempts/' + activeExam.id).transaction(c => (c || 0) + 1);
            db.ref('examResults').push({
                studentName: userData.name,
                studentPhone: userPhone,
                examTitle: activeExam.title,
                score: grade + "%",
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            alert("انتهى الاختبار! درجتك هي: " + grade + "%");
            location.reload();
        }

        // أدوات مساعدة
        function shuffle(arr) {
            return arr.sort(() => Math.random() - 0.5);
        }

        function logout() { localStorage.clear(); window.location.href = "go.html"; }

    </script>
</body>
</html>
