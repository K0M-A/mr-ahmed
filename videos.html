<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø£Ø³ØªØ§Ø° Ø£Ø­Ù…Ø¯ Ø´Ø¹Ø¨Ø§Ù† | Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #d4af37; --bg: #050505; --text: #e2e8f0; }
        body { background: var(--bg); color: var(--text); font-family: 'Cairo', sans-serif; margin: 0; padding-bottom: 100px; -webkit-user-select: none; user-select: none; }
        .container { max-width: 1000px; margin: 100px auto 20px; padding: 0 20px; }
        
        #admin-upload-panel { display: none; background: #111; padding: 25px; border-radius: 20px; border: 2px dashed var(--primary); margin-bottom: 40px; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #333; background: #1a1a1a; color: #fff; }
        
        .course-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .course-card { background: #111; border-radius: 20px; overflow: hidden; border: 1px solid #222; transition: 0.3s; position: relative; }
        .course-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .course-info { padding: 20px; }
        .course-price { color: var(--primary); font-weight: 900; font-size: 1.2rem; }
        
        #video-player-container { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 10000; justify-content: center; align-items: center; 
        }
        video { width: 90%; max-height: 80vh; border-radius: 15px; box-shadow: 0 0 50px rgba(0,0,0,1); }
        
        #watermark {
            position: absolute; color: rgba(255, 255, 255, 0.15); font-size: 14px;
            pointer-events: none; z-index: 10001; white-space: nowrap;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5); font-weight: bold;
        }

        .btn { padding: 12px 25px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .btn-gold { background: var(--primary); color: #000; }
        .close-video { position: absolute; top: 20px; right: 20px; background: red; color: white; padding: 10px 20px; border-radius: 10px; cursor: pointer; z-index: 10002; }

        header { position: fixed; top: 0; width: 100%; background: rgba(10,10,10,0.9); padding: 15px 5%; display: flex; justify-content: space-between; z-index: 1000; border-bottom: 1px solid #222; }
    </style>
</head>
<body oncontextmenu="return false;">

    <header>
        <div style="font-weight: 900; color: var(--primary);">ğŸ¥ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ù…Ù†ØµØ©</div>
        <div id="user-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
    </header>

    <div class="container">
        <section id="admin-upload-panel">
            <h2 style="color: var(--primary);">Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³/Ù…Ø­Ø§Ø¶Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <input type="text" id="course-name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³">
            <textarea id="course-desc" placeholder="ÙˆØµÙ Ø§Ù„ÙƒÙˆØ±Ø³"></textarea>
            <input type="text" id="video-url" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±">
            <input type="number" id="course-price" placeholder="Ø³Ø¹Ø± Ø§Ù„ÙƒÙˆØ±Ø³ (Ø¬.Ù…)">
            <button class="btn btn-gold" onclick="uploadCourse()">Ù†Ø´Ø± Ø§Ù„ÙƒÙˆØ±Ø³</button>
        </section>

        <h2 id="section-title">Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
        <div id="course-display" class="course-grid"></div>
    </div>

    <div id="video-player-container">
        <div class="close-video" onclick="closeVideo()">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ã—</div>
        <div id="watermark"></div>
        <video id="protected-video" controlsList="nodownload" oncontextmenu="return false;">
            <source id="video-source" src="" type="video/mp4">
        </video>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBfkxj5I7UOEETOf9GRqGgqEaEoqPtPMek",
            authDomain: "mrahmed-925d8.firebaseapp.com",
            databaseURL: "https://mrahmed-925d8-default-rtdb.firebaseio.com",
            projectId: "mrahmed-925d8",
            storageBucket: "mrahmed-925d8.firebasestorage.app",
            messagingSenderId: "83939909031",
            appId: "1:83939909031:web:adb0b10d41b9df6c602a82"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const userPhone = localStorage.getItem('userLoggedIn');
        let userData = null;
        let isAdmin = false;

        // --- 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---
        if (!userPhone) {
            window.location.href = "go.html";
        } else {
            db.ref('students/' + userPhone).on('value', (snap) => {
                userData = snap.val();
                if (!userData) { window.location.href = "go.html"; return; }
                
                // Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù„Ø§ Ù†Ù‚ÙˆÙ… Ø¨ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ø­Ø¸Ø± Ø£Ø¨Ø¯Ø§Ù‹ØŒ ÙÙ‚Ø· Ù†Ù‚Ø±Ø£Ù‡Ø§
                if (userData.status === "blocked") {
                    document.body.innerHTML = "<h1 style='color:white; text-align:center; margin-top:100px;'>Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¹Ø·Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù….</h1>";
                    return;
                }
                
                document.getElementById('user-status').innerText = userData.name;
                
                if (userData.role === "admin" || userPhone === "01025768529") {
                    isAdmin = true;
                    document.getElementById('admin-upload-panel').style.display = 'block';
                }
                loadCourses();
            });
        }

        // --- 2. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯Ù…Ù† ---
        function uploadCourse() {
            const name = document.getElementById('course-name').value;
            const desc = document.getElementById('course-desc').value;
            const url = document.getElementById('video-url').value;
            const price = document.getElementById('course-price').value;
            if(!name || !url || !price) return alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            db.ref('courses').push({ name, desc, url, price: parseInt(price) })
            .then(() => { alert("ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­"); location.reload(); });
        }

        // --- 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø·Ø§Ù„Ø¨ ---
        function loadCourses() {
            db.ref('courses').on('value', (snap) => {
                const container = document.getElementById('course-display');
                container.innerHTML = '';
                snap.forEach(child => {
                    const c = child.val();
                    const key = child.key;
                    const isBought = (userData.courses && userData.courses[key]) || isAdmin;

                    container.innerHTML += `
                        <div class="course-card">
                            <div class="course-info">
                                <h3>${c.name}</h3>
                                <p style="font-size:0.8rem; opacity:0.7">${c.desc}</p>
                                <div class="course-price">${isAdmin ? 'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…' : c.price + ' Ø¬.Ù…'}</div>
                                <button class="btn btn-gold" style="width:100%; margin-top:15px;" 
                                    onclick="handleCourseAction('${key}', '${c.url}', ${c.price}, ${isBought})">
                                    ${isBought ? 'Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¢Ù†' : 'Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©'}
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        function handleCourseAction(id, url, price, isBought) {
            if (isBought) {
                openProtectedVideo(url);
            } else {
                if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø´Ø±Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨Ù€ ${price} Ø¬.Ù…ØŸ`)) {
                    const balance = userData.balance || 0;
                    if (balance >= price) {
                        db.ref('students/' + userPhone).update({
                            balance: balance - price,
                            [`courses/${id}`]: true
                        }).then(() => alert("ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!"));
                    } else { alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ."); }
                }
            }
        }

        // --- 4. Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø­Ø¸Ø±) ---
        function openProtectedVideo(url) {
            const player = document.getElementById('video-player-container');
            const video = document.getElementById('protected-video');
            const source = document.getElementById('video-source');
            const watermark = document.getElementById('watermark');

            source.src = url;
            video.load();
            player.style.display = 'flex';
            
            watermark.innerText = `${userData.name} - ${userPhone}`;
            moveWatermark();
        }

        function moveWatermark() {
            const wm = document.getElementById('watermark');
            const move = () => {
                wm.style.left = Math.random() * (window.innerWidth - 180) + 'px';
                wm.style.top = Math.random() * (window.innerHeight - 50) + 'px';
            };
            move();
            setInterval(move, 5000);
        }

        function closeVideo() {
            const video = document.getElementById('protected-video');
            video.pause();
            document.getElementById('video-player-container').style.display = 'none';
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙØªØ­ Ø§Ù„Ø£Ø¯ÙˆØ§Øª (Ù„Ù„Ø·Ø§Ù„Ø¨ ÙÙ‚Ø·)
        setInterval(() => {
            if (isAdmin) return;
            const threshold = 160;
            const isDevOpen = window.outerWidth - window.innerWidth > threshold || window.outerHeight - window.innerHeight > threshold;
            if (isDevOpen) {
                closeVideo();
                // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ¯ Ø­Ø¸Ø± Ù‡Ù†Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
            }
        }, 1000);

        // Ù…Ù†Ø¹ Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª (Ù„Ù„Ø·Ø§Ù„Ø¨ ÙÙ‚Ø·)
        document.onkeydown = (e) => {
            if (isAdmin) return true;
            if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) || (e.ctrlKey && e.keyCode == 85)) {
                return false;
            }
        };

        // ØªØ¹ØªÙŠÙ… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´Ø§Ø´Ø©/ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ÙÙˆÙƒØ³
        window.onblur = () => { if(!isAdmin) document.getElementById('protected-video').style.filter = "blur(60px)"; };
        window.onfocus = () => { document.getElementById('protected-video').style.filter = "none"; };

    </script>
</body>
</html>
